!function(t,e){if("function"==typeof define&&define.amd)define(["backbone","underscore"],e);else if("undefined"!=typeof module&&module.exports){var i=require("backbone"),n=require("underscore");module.exports=e(i,n)}else e(t.Backbone,t._)}(this,function(t,e){var i=t.Collection=function(t,i){i||(i={}),this.preinitialize.apply(this,arguments),i.model&&(this.model=i.model),void 0!==i.comparator&&(this.comparator=i.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,e.extend({silent:!0},i))},n={add:!0,remove:!0,merge:!0},r={add:!0,remove:!1},s=function(t,e,i){i=Math.min(Math.max(i,0),t.length);var n,r=Array(t.length-i),s=e.length;for(n=0;n<r.length;n++)r[n]=t[n+i];for(n=0;n<s;n++)t[n+i]=e[n];for(n=0;n<r.length;n++)t[n+s+i]=r[n]};e.extend(i.prototype,t.Events,{model:Model,preinitialize:function(){},initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return t.sync.apply(this,arguments)},add:function(t,i){return this.set(t,e.extend({merge:!1},i,r))},remove:function(t,i){i=e.extend({},i);var n=!e.isArray(t);t=n?[t]:t.slice();var r=this._removeModels(t,i);return!i.silent&&r.length&&(i.changes={added:[],merged:[],removed:r},this.trigger("update",this,i)),n?r[0]:r},set:function(t,i){if(null!=t){i=e.extend({},n,i),i.parse&&!this._isModel(t)&&(t=this.parse(t,i)||[]);var r=!e.isArray(t);t=r?[t]:t.slice();var o=i.at;null!=o&&(o=+o),o>this.length&&(o=this.length),o<0&&(o+=this.length+1);var h,l,u=[],c=[],d=[],a=[],f={},p=i.add,m=i.merge,v=i.remove,g=!1,y=this.comparator&&null==o&&!1!==i.sort,_=e.isString(this.comparator)?this.comparator:null;for(l=0;l<t.length;l++){h=t[l];var b=this.get(h);if(b){if(m&&h!==b){var x=this._isModel(h)?h.attributes:h;i.parse&&(x=b.parse(x,i)),b.set(x,i),d.push(b),y&&!g&&(g=b.hasChanged(_))}f[b.cid]||(f[b.cid]=!0,u.push(b)),t[l]=b}else p&&(h=t[l]=this._prepareModel(h,i))&&(c.push(h),this._addReference(h,i),f[h.cid]=!0,u.push(h))}if(v){for(l=0;l<this.length;l++)h=this.models[l],f[h.cid]||a.push(h);a.length&&this._removeModels(a,i)}var I=!1,M=!y&&p&&v;if(u.length&&M?(I=this.length!==u.length||e.some(this.models,function(t,e){return t!==u[e]}),this.models.length=0,s(this.models,u,0),this.length=this.models.length):c.length&&(y&&(g=!0),s(this.models,c,null==o?this.length:o),this.length=this.models.length),g&&this.sort({silent:!0}),!i.silent){for(l=0;l<c.length;l++)null!=o&&(i.index=o+l),h=c[l],h.trigger("add",h,this,i);(g||I)&&this.trigger("sort",this,i),(c.length||a.length||d.length)&&(i.changes={added:c,removed:a,merged:d},this.trigger("update",this,i))}return r?t[0]:t}},reset:function(t,i){i=i?e.clone(i):{};for(var n=0;n<this.models.length;n++)this._removeReference(this.models[n],i);return i.previousModels=this.models,this._reset(),t=this.add(t,e.extend({silent:!0},i)),i.silent||this.trigger("reset",this,i),t},push:function(t,i){return this.add(t,e.extend({at:this.length},i))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t)},unshift:function(t,i){return this.add(t,e.extend({at:0},i))},shift:function(t){var e=this.at(0);return this.remove(e,t)},slice:function(){return slice.apply(this.models,arguments)},get:function(t){if(null!=t)return this._byId[t]||this._byId[this.modelId(this._isModel(t)?t.attributes:t)]||t.cid&&this._byId[t.cid]},has:function(t){return null!=this.get(t)},at:function(t){return t<0&&(t+=this.length),this.models[t]},where:function(t,e){return this[e?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)},sort:function(t){var i=this.comparator;if(!i)throw new Error("Cannot sort a set without a comparator");t||(t={});var n=i.length;return e.isFunction(i)&&(i=i.bind(this)),1===n||e.isString(i)?this.models=this.sortBy(i):this.models.sort(i),t.silent||this.trigger("sort",this,t),this},pluck:function(t){return this.map(t+"")},fetch:function(t){t=e.extend({parse:!0},t);var i=t.success,n=this;return t.success=function(e){var r=t.reset?"reset":"set";n[r](e,t),i&&i.call(t.context,n,e,t),n.trigger("sync",n,e,t)},y(this,t),this.sync("read",this,t)},create:function(t,i){i=i?e.clone(i):{};var n=i.wait;if(!(t=this._prepareModel(t,i)))return!1;n||this.add(t,i);var r=this,s=i.success;return i.success=function(t,e,i){n&&r.add(t,i),s&&s.call(i.context,t,e,i)},t.save(null,i),t},parse:function(t,e){return t},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})},modelId:function(t){return t[this.model.prototype.idAttribute||"id"]},values:function(){return new h(this,l)},keys:function(){return new h(this,u)},entries:function(){return new h(this,c)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(t,i){if(this._isModel(t))return t.collection||(t.collection=this),t;i=i?e.clone(i):{},i.collection=this;var n=new this.model(t,i);return n.validationError?(this.trigger("invalid",this,n.validationError,i),!1):n},_removeModels:function(t,e){for(var i=[],n=0;n<t.length;n++){var r=this.get(t[n]);if(r){var s=this.indexOf(r);this.models.splice(s,1),this.length--,delete this._byId[r.cid];var o=this.modelId(r.attributes);null!=o&&delete this._byId[o],e.silent||(e.index=s,r.trigger("remove",r,this,e)),i.push(r),this._removeReference(r,e)}}return i},_isModel:function(t){return t instanceof Model},_addReference:function(t,e){this._byId[t.cid]=t;var i=this.modelId(t.attributes);null!=i&&(this._byId[i]=t),t.on("all",this._onModelEvent,this)},_removeReference:function(t,e){delete this._byId[t.cid];var i=this.modelId(t.attributes);null!=i&&delete this._byId[i],this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,n){if(e){if(("add"===t||"remove"===t)&&i!==this)return;if("destroy"===t&&this.remove(e,n),"change"===t){var r=this.modelId(e.previousAttributes()),s=this.modelId(e.attributes);r!==s&&(null!=r&&delete this._byId[r],null!=s&&(this._byId[s]=e))}}this.trigger.apply(this,arguments)}});var o="function"==typeof Symbol&&Symbol.iterator;o&&(i.prototype[o]=i.prototype.values);var h=function(t,e){this._collection=t,this._kind=e,this._index=0},l=1,u=2,c=3;o&&(h.prototype[o]=function(){return this}),h.prototype.next=function(){if(this._collection){if(this._index<this._collection.length){var t=this._collection.at(this._index);this._index++;var e;if(this._kind===l)e=t;else{var i=this._collection.modelId(t.attributes);e=this._kind===u?i:[i,t]}return{value:e,done:!1}}this._collection=void 0}return{value:void 0,done:!0}};var d=function(t,e,i,n){switch(e){case 1:return function(){return t[i](this[n])};case 2:return function(e){return t[i](this[n],e)};case 3:return function(e,r){return t[i](this[n],f(e,this),r)};case 4:return function(e,r,s){return t[i](this[n],f(e,this),r,s)};default:return function(){var e=slice.call(arguments);return e.unshift(this[n]),t[i].apply(t,e)}}},a=function(t,i,n,r){e.each(n,function(e,n){i[n]&&(t.prototype[n]=d(i,e,n,r))})},f=function(t,i){return e.isFunction(t)?t:e.isObject(t)&&!i._isModel(t)?p(t):e.isString(t)?function(e){return e.get(t)}:t},p=function(t){var i=e.matches(t);return function(t){return i(t.attributes)}},m={forEach:3,each:3,map:3,collect:3,reduce:0,foldl:0,inject:0,reduceRight:0,foldr:0,find:3,detect:3,filter:3,select:3,reject:3,every:3,all:3,some:3,any:3,include:3,includes:3,contains:3,invoke:0,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3,groupBy:3,countBy:3,sortBy:3,indexBy:3,findIndex:3,findLastIndex:3},v={keys:1,values:1,pairs:1,invert:1,pick:0,omit:0,chain:1,isEmpty:1};e.each([[i,m,"models"],[Model,v,"attributes"]],function(t){var i=t[0],n=t[1],r=t[2];i.mixin=function(t){var n=e.reduce(e.functions(t),function(t,e){return t[e]=0,t},{});a(i,t,n,r)},a(i,e,n,r)});var g=function(t,i){var n,r=this;return n=t&&e.has(t,"constructor")?t.constructor:function(){return r.apply(this,arguments)},e.extend(n,r,i),n.prototype=e.create(r.prototype,t),n.prototype.constructor=n,n.__super__=r.prototype,n};i.extend=g;var y=function(t,e){var i=e.error;e.error=function(n){i&&i.call(e.context,t,n,e),t.trigger("error",t,n,e)}};return i});
//# sourceMappingURL=backbone.collection.js.map